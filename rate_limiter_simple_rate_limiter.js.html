<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>rate_limiter/simple_rate_limiter.js - Oracle NoSQL Database Node.js SDK</title>
    
    
    
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav class="wrap">
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h3>Tutorials</h3><ul><li><a href="tutorial-connect-cloud.html">Connecting an Application to Oracle NoSQL Database Cloud Service</a></li><li><a href="tutorial-connect-on-prem.html">Connecting an Application to On-Premise Oracle NoSQL Database</a></li><li><a href="tutorial-tables.html">Working With Tables</a></li></ul><h3>Classes</h3><ul><li><a href="AdminState.html">AdminState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="AdminState.html#toString">toString</a></li></ul></li><li><a href="CapacityMode.html">CapacityMode</a><ul class='methods'><li data-type='method' style='display: none;'><a href="CapacityMode.html#toString">toString</a></li></ul></li><li><a href="Consistency.html">Consistency</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Consistency.html#toString">toString</a></li></ul></li><li><a href="Enum.html">Enum</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Enum.html#toString">toString</a></li></ul></li><li><a href="ErrorCode.html">ErrorCode</a><ul class='methods'><li data-type='method' style='display: none;'><a href="ErrorCode.html#toString">toString</a></li></ul></li><li><a href="NoSQLArgumentError.html">NoSQLArgumentError</a></li><li><a href="NoSQLAuthorizationError.html">NoSQLAuthorizationError</a></li><li><a href="NoSQLClient.html">NoSQLClient</a><ul class='methods'><li data-type='method' style='display: none;'><a href="NoSQLClient.html#adminDDL">adminDDL</a></li><li data-type='method' style='display: none;'><a href="NoSQLClient.html#adminStatus">adminStatus</a></li><li data-type='method' style='display: none;'><a href="NoSQLClient.html#close">close</a></li><li data-type='method' style='display: none;'><a href="NoSQLClient.html#delete">delete</a></li><li data-type='method' style='display: none;'><a href="NoSQLClient.html#deleteIfVersion">deleteIfVersion</a></li><li data-type='method' style='display: none;'><a href="NoSQLClient.html#deleteMany">deleteMany</a></li><li data-type='method' style='display: none;'><a href="NoSQLClient.html#deleteRange">deleteRange</a></li><li data-type='method' style='display: none;'><a href="NoSQLClient.html#forCompletion">forCompletion</a></li><li data-type='method' style='display: none;'><a href="NoSQLClient.html#forTableState">forTableState</a></li><li data-type='method' style='display: none;'><a href="NoSQLClient.html#get">get</a></li><li data-type='method' style='display: none;'><a href="NoSQLClient.html#getIndex">getIndex</a></li><li data-type='method' style='display: none;'><a href="NoSQLClient.html#getIndexes">getIndexes</a></li><li data-type='method' style='display: none;'><a href="NoSQLClient.html#getSerialVersion">getSerialVersion</a></li><li data-type='method' style='display: none;'><a href="NoSQLClient.html#getTable">getTable</a></li><li data-type='method' style='display: none;'><a href="NoSQLClient.html#getTableUsage">getTableUsage</a></li><li data-type='method' style='display: none;'><a href="NoSQLClient.html#listNamespaces">listNamespaces</a></li><li data-type='method' style='display: none;'><a href="NoSQLClient.html#listRoles">listRoles</a></li><li data-type='method' style='display: none;'><a href="NoSQLClient.html#listTables">listTables</a></li><li data-type='method' style='display: none;'><a href="NoSQLClient.html#listUsers">listUsers</a></li><li data-type='method' style='display: none;'><a href="NoSQLClient.html#precacheAuth">precacheAuth</a></li><li data-type='method' style='display: none;'><a href="NoSQLClient.html#prepare">prepare</a></li><li data-type='method' style='display: none;'><a href="NoSQLClient.html#put">put</a></li><li data-type='method' style='display: none;'><a href="NoSQLClient.html#putIfAbsent">putIfAbsent</a></li><li data-type='method' style='display: none;'><a href="NoSQLClient.html#putIfPresent">putIfPresent</a></li><li data-type='method' style='display: none;'><a href="NoSQLClient.html#putIfVersion">putIfVersion</a></li><li data-type='method' style='display: none;'><a href="NoSQLClient.html#putMany">putMany</a></li><li data-type='method' style='display: none;'><a href="NoSQLClient.html#query">query</a></li><li data-type='method' style='display: none;'><a href="NoSQLClient.html#queryIterable">queryIterable</a></li><li data-type='method' style='display: none;'><a href="NoSQLClient.html#setTableLimits">setTableLimits</a></li><li data-type='method' style='display: none;'><a href="NoSQLClient.html#tableDDL">tableDDL</a></li><li data-type='method' style='display: none;'><a href="NoSQLClient.html#writeMany">writeMany</a></li></ul></li><li><a href="NoSQLError.html">NoSQLError</a></li><li><a href="NoSQLNetworkError.html">NoSQLNetworkError</a></li><li><a href="NoSQLProtocolError.html">NoSQLProtocolError</a></li><li><a href="NoSQLQueryError.html">NoSQLQueryError</a></li><li><a href="NoSQLServiceError.html">NoSQLServiceError</a></li><li><a href="NoSQLTimeoutError.html">NoSQLTimeoutError</a></li><li><a href="NoSQLUnsupportedProtocolError.html">NoSQLUnsupportedProtocolError</a></li><li><a href="PreparedStatement.html">PreparedStatement</a><ul class='methods'><li data-type='method' style='display: none;'><a href="PreparedStatement.html#clearAll">clearAll</a></li><li data-type='method' style='display: none;'><a href="PreparedStatement.html#copyStatement">copyStatement</a></li><li data-type='method' style='display: none;'><a href="PreparedStatement.html#set">set</a></li></ul></li><li><a href="Region.html">Region</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Region.html#toString">toString</a></li></ul></li><li><a href="ReplicaAckPolicy.html">ReplicaAckPolicy</a></li><li><a href="ServiceType.html">ServiceType</a><ul class='methods'><li data-type='method' style='display: none;'><a href="ServiceType.html#toString">toString</a></li></ul></li><li><a href="SimpleRateLimiter.html">SimpleRateLimiter</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SimpleRateLimiter.html#consumeUnits">consumeUnits</a></li><li data-type='method' style='display: none;'><a href="SimpleRateLimiter.html#onThrottle">onThrottle</a></li><li data-type='method' style='display: none;'><a href="SimpleRateLimiter.html#setLimit">setLimit</a></li></ul></li><li><a href="SyncPolicy.html">SyncPolicy</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SyncPolicy.html#toString">toString</a></li></ul></li><li><a href="TableState.html">TableState</a><ul class='methods'><li data-type='method' style='display: none;'><a href="TableState.html#toString">toString</a></li></ul></li><li><a href="TTLUtil.html">TTLUtil</a><ul class='methods'><li data-type='method' style='display: none;'><a href="TTLUtil.html#.fromExpirationTime">fromExpirationTime</a></li><li data-type='method' style='display: none;'><a href="TTLUtil.html#.ofDays">ofDays</a></li><li data-type='method' style='display: none;'><a href="TTLUtil.html#.ofHours">ofHours</a></li><li data-type='method' style='display: none;'><a href="TTLUtil.html#.toDays">toDays</a></li><li data-type='method' style='display: none;'><a href="TTLUtil.html#.toExpirationTime">toExpirationTime</a></li><li data-type='method' style='display: none;'><a href="TTLUtil.html#.toExpirationTimeMillis">toExpirationTimeMillis</a></li><li data-type='method' style='display: none;'><a href="TTLUtil.html#.toHours">toHours</a></li><li data-type='method' style='display: none;'><a href="TTLUtil.html#.toMillis">toMillis</a></li></ul></li></ul><h3>Interfaces</h3><ul><li><a href="RateLimiter.html">RateLimiter</a><ul class='methods'><li data-type='method' style='display: none;'><a href="RateLimiter.html#consumeUnits">consumeUnits</a></li><li data-type='method' style='display: none;'><a href="RateLimiter.html#onThrottle">onThrottle</a></li><li data-type='method' style='display: none;'><a href="RateLimiter.html#setLimit">setLimit</a></li></ul></li></ul><h3>Events</h3><ul><li><a href="NoSQLClient.html#event:consumedCapacity">consumedCapacity</a></li><li><a href="NoSQLClient.html#event:error">error</a></li><li><a href="NoSQLClient.html#event:retryable">retryable</a></li><li><a href="NoSQLClient.html#event:tableState">tableState</a></li></ul><h3>Global</h3><ul><li><a href="global.html#AdminResult">AdminResult</a></li><li><a href="global.html#AuthConfig">AuthConfig</a></li><li><a href="global.html#AuthorizationProvider">AuthorizationProvider</a></li><li><a href="global.html#Config">Config</a></li><li><a href="global.html#ConsumedCapacity">ConsumedCapacity</a></li><li><a href="global.html#ContinuationKey">ContinuationKey</a></li><li><a href="global.html#DBNumberConfig">DBNumberConfig</a></li><li><a href="global.html#delay">delay</a></li><li><a href="global.html#DelegationTokenProvider">DelegationTokenProvider</a></li><li><a href="global.html#DeleteResult">DeleteResult</a></li><li><a href="global.html#doRetry">doRetry</a></li><li><a href="global.html#Durability">Durability</a></li><li><a href="global.html#FieldRange">FieldRange</a></li><li><a href="global.html#FieldValue">FieldValue</a></li><li><a href="global.html#getAuthorization">getAuthorization</a></li><li><a href="global.html#GetResult">GetResult</a></li><li><a href="global.html#IAMConfig">IAMConfig</a></li><li><a href="global.html#IAMCredentials">IAMCredentials</a></li><li><a href="global.html#IAMCredentialsProvider">IAMCredentialsProvider</a></li><li><a href="global.html#IndexInfo">IndexInfo</a></li><li><a href="global.html#Key">Key</a></li><li><a href="global.html#KVStoreAuthConfig">KVStoreAuthConfig</a></li><li><a href="global.html#KVStoreCredentials">KVStoreCredentials</a></li><li><a href="global.html#KVStoreCredentialsProvider">KVStoreCredentialsProvider</a></li><li><a href="global.html#ListTablesResult">ListTablesResult</a></li><li><a href="global.html#loadDelegationToken">loadDelegationToken</a></li><li><a href="global.html#loadIAMCredentials">loadIAMCredentials</a></li><li><a href="global.html#loadKVStoreCredentials">loadKVStoreCredentials</a></li><li><a href="global.html#MultiDeleteResult">MultiDeleteResult</a></li><li><a href="global.html#NumberLibConfig">NumberLibConfig</a></li><li><a href="global.html#NumberLibMethods">NumberLibMethods</a></li><li><a href="global.html#NumberLibPrecision">NumberLibPrecision</a></li><li><a href="global.html#NumberLibRoundingMode">NumberLibRoundingMode</a></li><li><a href="global.html#Operation">Operation</a></li><li><a href="global.html#PrepareResult">PrepareResult</a></li><li><a href="global.html#PutResult">PutResult</a></li><li><a href="global.html#QueryResult">QueryResult</a></li><li><a href="global.html#RetryConfig">RetryConfig</a></li><li><a href="global.html#RetryHandler">RetryHandler</a></li><li><a href="global.html#RoundingModesMap">RoundingModesMap</a></li><li><a href="global.html#Row">Row</a></li><li><a href="global.html#TableLimits">TableLimits</a></li><li><a href="global.html#TableResult">TableResult</a></li><li><a href="global.html#TableUsage">TableUsage</a></li><li><a href="global.html#TableUsageResult">TableUsageResult</a></li><li><a href="global.html#TimeToLive">TimeToLive</a></li><li><a href="global.html#UserInfo">UserInfo</a></li><li><a href="global.html#Version">Version</a></li><li><a href="global.html#WriteMultipleResult">WriteMultipleResult</a></li><li><a href="global.html#WriteOperation">WriteOperation</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">rate_limiter/simple_rate_limiter.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*-
 * Copyright (c) 2018, 2022 Oracle and/or its affiliates. All rights reserved.
 *
 * Licensed under the Universal Permissive License v 1.0 as shown at
 *  https://oss.oracle.com/licenses/upl/
 */

'use strict';

const process = require('process');

const sleep = require('../utils').sleep;
const NoSQLTimeoutError = require('../error').NoSQLTimeoutError;

const NANOS_IN_SEC = 1000000000;
const NANOS_IN_MS = 1000000;

/**
 * @classdesc
 * Cloud Service or Cloud Simulator only.
 * &lt;p>
 * Default implementation of rate limiter class used by the driver.
 * Two rate limiter instances are used per each table in use, one for reads
 * and another for writes.  See {@link RateLimiter}.
 * &lt;p>
 * This implementation uses a token bucket based algorithm, although
 * the state is kept in terms of nano time instead of tokens.  It is assumed
 * that the units refill at constant rate being equivalent to the set limit
 * of units per second.  The state is kept in terms of &lt;em>nextNano&lt;/em> which
 * is the time when the next operation can proceed without waiting, meaning
 * the limiter is at its limit.  All operations issued before
 * &lt;em>nextNano&lt;/em> will have to wait accordingly.  Based on the value of
 * &lt;em>nextNano&lt;/em> and the current time, the appropriate wait time may be
 * computed before the wait begins.  If current time is >= &lt;em>nextNano&lt;/em>,
 * no wait is needed.
 * &lt;p>
 * Note that when {@link SimpleRateLimiter#consumeUnits} is called, the
 * entered units will only affect the wait time of subsequent operations and
 * not the current operation, which will use the value of &lt;em>nextNano&lt;/em> as
 * it was to determine its wait time.  This should avoid needless wait time
 * when the operations come in rarely.
 * &lt;p> Because every time when {@link SimpleRateLimiter#consumeUnits} is
 * called with units > 0, &lt;em>nextNano&lt;/em> is pushed forward, the operations
 * will be effectively staggered in time accoridng to the order of their
 * arrival with no preferrential treatment given to any operation, thus
 * avoiding starvation.
 * &lt;p>
 * This limiter uses burst mode, allowing a set maximum number of stored units
 * that has not been used to be consumed immediately without waiting. This
 * value is expressed as &lt;em>maxBurstSecs&lt;/em> or duration, which is
 * effectively a maximum number of seconds worth of unused stored units.
 * The minimum duration is internally bound such that at least one unused unit
 * may be consumed without waiting.  The default value of duration is
 * 30 seconds.
 * 
 * @see {@link RateLimiter}
 * @see {@link Config}
 */
class SimpleRateLimiter {

    /**
     * Constructs an instance of SimpleRateLimiter
     * @param {number} [maxBurstSecs=30] Duration as described above
     */
    constructor(maxBurstSecs = 30) {
        this._nanosPerUnit = null;
        this._durationNanos = BigInt(maxBurstSecs * NANOS_IN_SEC);
        this._removePast = true;
        this._nextNano = BigInt(0);
    }

    _consume(units, nowNanos, timeout) {
        /* If disabled, just return success */
        if (this._nanosPerUnit == null) {
            return 0;
        }

        /* determine how many nanos we need to add based on units requested */
        const nanosNeeded = units * this._nanosPerUnit;

        /* ensure we never use more from the past than duration allows */
        let maxPast;
        if (this._removePast) {
            maxPast = nowNanos;
            this._removePast = false;
        } else {
            maxPast = nowNanos - this._durationNanos;
        }

        if (this._nextNano &lt; maxPast) {
            this._nextNano = maxPast;
        }

        /* compute the new "next nano used" */
        const newNext = this._nextNano + BigInt(Math.round(nanosNeeded));

        /* if units &lt; 0, we're "returning" them */
        if (units &lt; 0) {
            /* consume the units */
            this._nextNano = newNext;
            return 0;
        }

        /*
         * if the limiter is currently under its limit, the consume
         * succeeds immediately (no sleep required).
         */
        if (this._nextNano &lt;= nowNanos) {
            /* consume the units */
            this._nextNano = newNext;
            return 0;
        }

        /*
         * determine the amount of time that the caller needs to sleep
         * for this limiter to go below its limit. Note that the limiter
         * is not guaranteed to be below the limit after this time, as
         * other consume calls may come in after this one and push the
         * "at the limit time" further out.
         */
        let sleepMs = Number(this._nextNano - nowNanos) / NANOS_IN_MS;
        if (sleepMs &lt; 1) {
            sleepMs = 1;
        }

        if (timeout == null || sleepMs &lt; timeout) {
            this._nextNano = newNext;
        }

        return sleepMs;
    }

    /**
     * Implements {@link RateLimiter#consumeUnits}
     * @async
     * @see {@link RateLimiter}
     * @param {number} units Number of units to consume
     * @param {number} timeout Timeout in milliseconds
     * @param {boolean} consumeOnTimeout Whether to consume units on timeout
     * or throw an error, see {@link RateLimiter#consumeUnits}
     * @returns {Promise}  Promise resolved with sleeping time in milliseconds
     * or rejected with {@link NoSQLTimeoutError}
     */
    async consumeUnits(units, timeout, consumeOnTimeout) {
        const msToSleep = this._consume(units, process.hrtime.bigint(),
            consumeOnTimeout ? null : timeout);

        if (msToSleep === 0) {
            return 0;
        }
        
        if (timeout != null &amp;&amp; msToSleep >= timeout) {
            //If timeout is reached we sleep for timeout ms
            await sleep(timeout);
            if (consumeOnTimeout) {
                return timeout;
            }
            //If timeout is reached and units were not consumed, we throw
            //timeout error.
            throw new NoSQLTimeoutError(`Rate limiter timed out waiting \
${timeout} ms for ${units} units`);
        }

        await sleep(msToSleep);
        return msToSleep;
    }

    /**
     * Implements {@link RateLimiter#setLimit}.  Sets the limiter limit
     * (rate) in units per second.  Also, enforces minimum duration to be able
     * to store at least one unused unit.  When changing table limits, will
     * prorate any unused units according to the new limit.
     * @param {number} limit Limit in units
     */
    setLimit(limit) {
        //If limit is not positive, assume that the limiter is disabled
        if (limit &lt;= 0) {
            this._nanosPerUnit = null;
            return;
        }

        const oldNanosPerUnit = this._nanosPerUnit;
        this._nanosPerUnit = NANOS_IN_SEC / limit;

        if (this._durationNanos &lt; this._nanosPerUnit) {
            this._durationNanos = BigInt(Math.round(this._nanosPerUnit));
        }

        if (oldNanosPerUnit != null) {
            const nowNanos = process.hrtime.bigint();
            //prorate any unused capacity?
            if (this._nextNano &lt; nowNanos) {
                this._nextNano = nowNanos -
                    (BigInt)(Math.round(((Number)(nowNanos - this._nextNano) *
                    this._nanosPerUnit / oldNanosPerUnit)));
            }
        }
    }

    /**
     * Implements {@link RateLimiter#onThrottle}.  Called when throttling
     * error occurs when using this rate limiter instance.  Current
     * implementation will remove any stored units by ensuring that
     * &lt;em>nextNano&lt;/em> is at least the current time.
     */
    onThrottle() {
        this._removePast = true;
    }

}

module.exports = SimpleRateLimiter;
</code></pre>
        </article>
    </section>





    
</div>

<br class="clear">

<footer>
Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
